# kintone Backup Scheduler

Windows 環境で kintone の自動・手動バックアップ/復元を行う Electron アプリケーションです。

## 主な機能

-   **自動バックアップ**: Windows タスクスケジューラと連携した定期実行
-   **差分バックアップ**: 前回実行時からの変更レコードのみを高速バックアップ
-   **全体バックアップ**: 全レコードのバックアップ
-   **添付ファイル保存**: レコードに添付されたファイルもローカルに保存
-   **復元機能**: 過去のバックアップから選択して復元
    -   全レコード復元または特定レコードのみ選択復元が可能
    -   レコード番号に基づく自動判定（既存レコードは更新、新規レコードは追加）
-   **実行ログ**: kintone アプリにバックアップ履歴を自動記録
-   **自動リトライ**: API エラー時の指数バックオフによる自動リトライ機能

## 必要な環境

-   Windows 10/11
-   Node.js 18.x 以上
-   kintone アカウント（管理者権限推奨）

## インストール

```bash
# 依存関係のインストール
npm install

# 開発モードで起動
npm run dev

# ビルド（Windows用実行ファイル作成）
npm run build

# ビルド（ディレクトリ出力のみ、インストーラー作成なし）
npm run build:dir
```

## セットアップ

1. アプリケーションを起動
2. kintone のサブドメイン、ユーザー名、パスワードを入力
    - または API トークンでの認証も可能
3. バックアップ記録用の kintone アプリ ID を入力
4. バックアップスケジュールを設定（曜日・時刻）
5. バックアップ対象のアプリを選択
6. 初回バックアップが自動実行されます

## kintone バックアップ記録アプリの設定

バックアップ履歴を記録するための kintone アプリを作成してください。
詳細なフィールド定義は `KINTONE_BACKUP_APP_FIELDS.md` を参照してください。

## データ保存形式

-   **メタデータ**: SQLite (`backup_data/metadata.db`)
-   **バックアップデータ**: JSON+ZIP 形式 (`backup_data/archives/`)
    -   `records.json`: レコードデータ本体
    -   `backup_metadata.json`: バックアップメタデータ（アプリ ID、フィールド情報、スキーマバージョンなど）
-   **添付ファイル**: `backup_data/attachments/[appId]/[recordId]/[backupDate]/`
-   **設定情報**: 暗号化された設定ファイル（kintone 認証情報を含む）

## コマンドライン引数

```bash
# スケジュール実行（ヘッドレスモード）
KintoneBackupScheduler.exe --scheduled

# 開発モード
npm run dev
```

## ライセンス

MIT

## 技術スタック

-   Electron 27.x
-   @kintone/rest-api-client 5.x
-   better-sqlite3 9.x
-   archiver 6.x
-   axios + axios-retry（指数バックオフ、Jitter 付きリトライ）
-   winston 3.x（ロギング）
-   electron-store 8.x（暗号化設定ストレージ）
-   fs-extra 11.x（ファイル操作）
-   unzipper 0.10.x（復元用）

## エラーハンドリングとリトライ

-   **自動リトライ**: API エラー時に最大 5 回まで自動リトライ
-   **指数バックオフ**: 初回 1 秒待機、最大 32 秒まで段階的に待機時間を延長
-   **Jitter 機能**: リトライ時の待機時間に±20%のランダム揺らぎを追加（サーバー負荷分散）
-   **Rate Limit 対応**: 429 エラー時は Retry-After ヘッダーに従って待機
-   **リトライ対象エラー**: 429, 500, 502, 503, 504 ステータスコード

## 復元機能の詳細

復元時は以下の動作を行います：

1. **レコード番号の自動判定**: バックアップ内のレコード番号とアプリ内の既存レコードを照合
2. **スマート復元**:
    - 既存レコードが見つかった場合: レコードを**更新**
    - 既存レコードがない場合: 新しいレコードとして**追加**
3. **システムフィールドの除外**: レコード番号、作成者、作成日時などの読み取り専用フィールドは自動的に除外
4. **選択的復元**: 特定のレコードのみを選んで復元することも可能

## セキュリティ

-   **認証情報の暗号化**: kintone のユーザー名、パスワード、API トークンは暗号化されて保存されます
-   **ローカル保存**: すべてのバックアップデータはローカルマシンにのみ保存され、外部サーバーには送信されません
-   **管理者権限**: Windows タスクスケジューラへの登録には管理者権限が必要です
