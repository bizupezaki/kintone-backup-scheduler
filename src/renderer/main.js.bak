// メイン画面のJavaScript

let currentConfig = null;
let allApps = [];
let selectedBackupId = null;
let availableRecords = [];

// 初期化
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // 設定の読み込み
        currentConfig = await window.electronAPI.getConfig();

        if (!currentConfig || !currentConfig.kintone || !currentConfig.apps) {
            // セットアップが必要
            alert('初回セットアップが必要です');
            // セットアップ画面を開く処理（今回は未実装）
            return;
        }

        // 初期データの読み込み
        await loadInitialData();
        setupEventListeners();
    } catch (error) {
        console.error('Initialization error:', error);
        alert('初期化エラー: ' + error.message);
    }
});

// 初期データの読み込み
async function loadInitialData() {
    await loadStatistics();
    await loadAppsForBackup();
    await loadBackupHistory();
}

// イベントリスナーの設定
function setupEventListeners() {
    // タブ切り替え
    document.querySelectorAll('.nav-tab').forEach((tab) => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // バックアップ実行
    document.getElementById('runBackupBtn').addEventListener('click', runManualBackup);

    // 復元関連
    document.getElementById('restoreAppSelect').addEventListener('change', loadBackupsForApp);
    document.getElementById('selectAllRecords').addEventListener('change', toggleSelectAllRecords);
    document.getElementById('executeRestoreBtn').addEventListener('click', executeRestore);

    // 設定ボタン
    document.getElementById('settingsBtn').addEventListener('click', openSettings);
}

// タブ切り替え
function switchTab(tabName) {
    document.querySelectorAll('.nav-tab').forEach((t) => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));

    document.querySelector(`.nav-tab[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}Tab`).classList.add('active');

    // 復元タブに切り替えたときにアプリ一覧を読み込む
    if (tabName === 'restore') {
        loadAppsForRestore();
    }
}

// 統計情報の読み込み
async function loadStatistics() {
    try {
        const history = await window.electronAPI.getBackupHistory({ limit: 1000 });
        const apps = currentConfig.apps || [];

        document.getElementById('totalApps').textContent = apps.length;
        document.getElementById('totalBackups').textContent = history.length;

        if (history.length > 0) {
            const lastBackup = history[0];
            const date = new Date(lastBackup.start_time);
            document.getElementById('lastBackupTime').textContent = formatDate(date);

            const totalRecords = history.reduce((sum, h) => sum + (h.record_count || 0), 0);
            document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
        }
    } catch (error) {
        console.error('Failed to load statistics:', error);
    }
}

// バックアップ用アプリリストの読み込み
async function loadAppsForBackup() {
    const container = document.getElementById('backupAppsList');
    container.innerHTML = '';

    const apps = currentConfig.apps || [];

    apps.forEach((app) => {
        const div = document.createElement('div');
        div.className = 'app-item';
        div.innerHTML = `
            <label class="checkbox-label">
                <input type="checkbox" class="backup-app-checkbox" data-app-id="${app.appId}" checked>
                <span class="app-name">${app.appName}</span>
                <span class="app-id">ID: ${app.appId}</span>
            </label>
        `;
        container.appendChild(div);
    });
}

// 手動バックアップの実行
async function runManualBackup() {
    const backupType = document.querySelector('input[name="backupType"]:checked').value;
    const selectedCheckboxes = document.querySelectorAll('.backup-app-checkbox:checked');

    if (selectedCheckboxes.length === 0) {
        alert('少なくとも1つのアプリを選択してください');
        return;
    }

    const selectedApps = Array.from(selectedCheckboxes).map((cb) => ({
        appId: cb.dataset.appId,
    }));

    const progressDiv = document.getElementById('backupProgress');
    const progressFill = document.getElementById('backupProgressFill');
    const progressText = document.getElementById('backupProgressText');

    progressDiv.style.display = 'block';
    document.getElementById('runBackupBtn').disabled = true;

    let completedCount = 0;
    const totalCount = selectedApps.length;
    const results = [];

    for (const app of selectedApps) {
        const appInfo = currentConfig.apps.find((a) => a.appId === app.appId);
        progressText.textContent = `バックアップ中: ${appInfo.appName} (${completedCount + 1}/${totalCount})`;

        try {
            const paths = await window.electronAPI.getAppPaths();
            const result = await window.electronAPI.runBackup({
                appId: app.appId,
                backupType,
                triggerType: '手動',
                hostname: paths.hostname,
                appVersion: paths.appVersion,
            });

            results.push({ ...result, success: true });
            completedCount++;
        } catch (error) {
            console.error(`Backup failed for app ${app.appId}:`, error);
            results.push({ appId: app.appId, success: false, error: error.message });
            completedCount++;
        }

        const progress = (completedCount / totalCount) * 100;
        progressFill.style.width = progress + '%';
    }

    // 完了
    progressText.textContent = 'バックアップ完了!';
    document.getElementById('runBackupBtn').disabled = false;

    // 結果表示
    const successCount = results.filter((r) => r.success).length;
    const failureCount = results.filter((r) => !r.success).length;

    alert(`バックアップが完了しました\n成功: ${successCount}件\n失敗: ${failureCount}件`);

    // 統計情報と履歴を再読み込み
    await loadStatistics();
    await loadBackupHistory();

    setTimeout(() => {
        progressDiv.style.display = 'none';
        progressFill.style.width = '0%';
    }, 2000);
}

// 復元用アプリリストの読み込み
async function loadAppsForRestore() {
    const select = document.getElementById('restoreAppSelect');
    select.innerHTML = '<option value="">選択してください</option>';

    const apps = currentConfig.apps || [];

    apps.forEach((app) => {
        const option = document.createElement('option');
        option.value = app.appId;
        option.textContent = `${app.appName} (ID: ${app.appId})`;
        select.appendChild(option);
    });
}

// アプリのバックアップ一覧を読み込む
async function loadBackupsForApp() {
    const appId = document.getElementById('restoreAppSelect').value;
    const backupsListDiv = document.getElementById('restoreBackupsList');
    const recordsListDiv = document.getElementById('restoreRecordsList');

    recordsListDiv.style.display = 'none';

    if (!appId) {
        backupsListDiv.style.display = 'none';
        return;
    }

    try {
        const backups = await window.electronAPI.getBackupHistory({
            app_id: appId,
            status: '成功',
            limit: 50,
        });

        const container = document.getElementById('backupsListContainer');
        container.innerHTML = '';

        if (backups.length === 0) {
            container.innerHTML = '<p>バックアップが見つかりません</p>';
        } else {
            backups.forEach((backup) => {
                const div = document.createElement('div');
                div.className = 'app-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <div>
                        <strong>${formatDateTime(backup.start_time)}</strong>
                        <span class="badge badge-${backup.backup_type === '全体' ? 'success' : 'warning'}">${backup.backup_type}</span>
                        <span style="margin-left: 10px; color: #666;">${backup.record_count}件</span>
                    </div>
                `;
                div.addEventListener('click', () => loadRecordsFromBackup(backup.id));
                container.appendChild(div);
            });
        }

        backupsListDiv.style.display = 'block';
    } catch (error) {
        console.error('Failed to load backups:', error);
        alert('バックアップ一覧の取得に失敗しました');
    }
}

// バックアップからレコード一覧を読み込む
async function loadRecordsFromBackup(backupId) {
    selectedBackupId = backupId;

    try {
        const records = await window.electronAPI.getBackupDetails(backupId);
        availableRecords = records;

        const container = document.getElementById('recordsListContainer');
        container.innerHTML = '';

        records.forEach((record, index) => {
            const recordId = record.$id?.value || index;
            const div = document.createElement('div');
            div.className = 'app-item';
            div.innerHTML = `
                <label class="checkbox-label">
                    <input type="checkbox" class="record-checkbox" data-record-id="${recordId}" checked>
                    <span>レコードID: ${recordId}</span>
                </label>
            `;
            container.appendChild(div);
        });

        document.getElementById('restoreRecordsList').style.display = 'block';
    } catch (error) {
        console.error('Failed to load records:', error);
        alert('レコード一覧の取得に失敗しました');
    }
}

// すべてのレコードを選択/解除
function toggleSelectAllRecords(e) {
    const checkboxes = document.querySelectorAll('.record-checkbox');
    checkboxes.forEach((cb) => {
        cb.checked = e.target.checked;
    });
}

// 復元実行
async function executeRestore() {
    const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');

    if (selectedCheckboxes.length === 0) {
        alert('少なくとも1つのレコードを選択してください');
        return;
    }

    const confirm = await window.electronAPI.showDialog({
        type: 'warning',
        buttons: ['キャンセル', '復元実行'],
        defaultId: 0,
        title: '復元の確認',
        message: `${selectedCheckboxes.length}件のレコードを復元します。よろしいですか?`,
    });

    if (confirm.response !== 1) {
        return;
    }

    const selectedRecordIds = Array.from(selectedCheckboxes).map((cb) => cb.dataset.recordId);

    try {
        document.getElementById('executeRestoreBtn').disabled = true;
        document.getElementById('executeRestoreBtn').textContent = '復元中...';

        const paths = await window.electronAPI.getAppPaths();
        await window.electronAPI.restoreRecords({
            backupId: selectedBackupId,
            selectedRecordIds,
            hostname: paths.hostname,
            appVersion: paths.appVersion,
        });

        alert('復元が完了しました');

        // 履歴を再読み込み
        await loadBackupHistory();

        // リセット
        document.getElementById('restoreAppSelect').value = '';
        document.getElementById('restoreBackupsList').style.display = 'none';
        document.getElementById('restoreRecordsList').style.display = 'none';
    } catch (error) {
        console.error('Restore failed:', error);
        alert('復元に失敗しました: ' + error.message);
    } finally {
        document.getElementById('executeRestoreBtn').disabled = false;
        document.getElementById('executeRestoreBtn').textContent = '復元実行';
    }
}

// バックアップ履歴の読み込み
async function loadBackupHistory() {
    try {
        const history = await window.electronAPI.getBackupHistory({ limit: 100 });
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';

        if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">履歴がありません</td></tr>';
            return;
        }

        history.forEach((item) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${formatDateTime(item.start_time)}</td>
                <td>${item.app_name || '-'}</td>
                <td><span class="badge badge-${getBadgeType(item.backup_type)}">${item.backup_type}</span></td>
                <td>${item.record_count || 0}件</td>
                <td><span class="badge badge-${getStatusBadge(item.status)}">${item.status}</span></td>
                <td>${item.duration_seconds ? item.duration_seconds.toFixed(2) + '秒' : '-'}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteBackup(${item.id})">削除</button></td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('Failed to load history:', error);
    }
}

// バックアップを削除
async function deleteBackup(backupId) {
    if (!confirm('このバックアップを削除しますか？\nバックアップファイルも削除されます。')) {
        return;
    }

    try {
        await window.electronAPI.deleteBackup(backupId);
        alert('バックアップを削除しました');
        await loadBackupHistory();
        await loadStatistics();
    } catch (error) {
        console.error('Failed to delete backup:', error);
        alert('削除に失敗しました: ' + error.message);
    }
}

// 設定画面を開く
function openSettings() {
    alert('設定画面は未実装です');
}

// ユーティリティ関数
function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString('ja-JP');
}

function formatDate(date) {
    return date.toLocaleDateString('ja-JP');
}

function getBadgeType(backupType) {
    if (backupType === '全体') return 'success';
    if (backupType === '差分') return 'warning';
    if (backupType === '復元') return 'info';
    return 'secondary';
}

function getStatusBadge(status) {
    if (status === '成功') return 'success';
    if (status === '失敗') return 'error';
    return 'warning';
}
